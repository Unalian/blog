# 操作系統-4-存儲器管理

## 4.1 存儲器

### 4.1.1 硬件

内存：Cpu  存儲器

外存：视频控制器 键盘控制器 usb控制器 硬盘控制器

cpu <--->存儲器 <--->外存

### 4.1.2 层次机构

寄存器  

 	|

高速缓存     < --- cpu访问 主存儲器比寄存器慢，所以需要緩存

​	 |

主存储器 

​	  |

磁盘缓存  固存移動比主存慢，因此需要緩存

​	  | 

固定磁盘（外存）

​	  |

可移动存储介质（U盘 移动硬盘 磁带机） 優點：容量大 缺點：速度慢
<!-- more -->
* 高速缓存介于寄存器和主存器之间的存储器，主要用于备份主存中较常用的指 令和数据，以减少对主存器的访问次数。

- 高速缓存的访问比寄存器慢，但其访问速度却远快于主存。容量也介于二者之 间。高速缓存的有效性是建立在“程序局部性原理”基础上。
  * 程序局部性原理：一條指令可能多次執行；程序運行一條接一條，具有局部性特征。
- 由于磁盘I/O速度远低于主存，因此设置了磁盘缓存，主要用于暂时存放频繁 使用的一部分磁盘数据

#### 4.2  程序的裝入和鏈接

* 如何将一个用户源程序变成一个可在内存中执行的程序，通常要经过3步骤:

1. 编译:由编译程序(Compiler)将用户源代码编译成若个目标模块 。

2. 链接:由链接程序(Linker)将编译后形成的一组目标模块，以及它们所需 要的库函数链接在一起，形成一个完整的装入模块 。

3. 装入:由装入程序(Loader)将装入模块装入内存。

#### 4.2.1 程序的裝入

(1) ***绝对装入方式*** 

如果知道程序将驻留在内存的什么位置，那么，编译程序将产生绝对地址的目标代码。

绝对装入程序按照装入模块中的地址，将程序和数据装入内存。装入模块 被装入内存后，由于程序中的逻辑地址与实际内存地址完全相同，故不需对 程序和数据的地址进行修改。

(2) ***可重定位装入方式***

把在装入时对目标程序中指令和数据的变换过程称为重定位。

采用静态重定位方法将程序装入内存,称为可重定位装入方式。

因为地址变换是在装入时一次完成的，以后不再改变，故称为静态重定位。

(3)***动态运行时装入方式*** 

装入程序将目标模块装入内存后，并不立即把装入模块中的相对地址转换为 绝对地址，而是把这种地址转换推迟到程序执行时进行，在硬件地址变换机构 的支持下，随着对每条指令或数据的访问自动进行地址变换，故称为动态重定 位。

采用动态重定位方法将程序装入内存，称为动态运行时装入方式 。

![](https://img.cetacis.dev/uploads/big/ff19d327ad7da5a5f878f546038c8ba5.png)

### 4.2.2 程序的鏈接 

鏈接時間：（1）先鏈接再裝入 （2）先裝入再鏈接

(1)、静态链接方式。

在程序运行之前，先将各目标模块及它们所需的库函数， 链接成一个完整的装配模块(又称执行模块)，以后不再拆开。我们把这种事 先进行链接的方式称为静态链接方式。

(2)、装入时动态链接程序的链接

是指将用户源程序编译后所得到的一组目标模块，在装入内存时，采用边 装入边链接的链接方式。即分别装入各模块，并且在装入的过程中修改相对地 址和外部引用地址。

優點：

1. 便于修改和更新

   若采用动态链接方式，由于各目标模块是分开存放的，所以要修改或更新各目 标模块，是件非常容易的事。

2. 便于实现对目标模块的共享

   采用装入时动态链接方式时，OS则很容易将一个目标模块链接到几个应用模 块上，实现多个应用程序对该模块的共享。

(3)、运行时动态链接 

各模块被独立装入系统，而且也不进行链接，运行时发现引用的地址是相对地址或者外部地址时，才发起链接，寻找正确的引用地址。

优点:凡在执行过程中未被用到的目标模块，都不会被调入内存和被链接到 装入模块上，这样不仅可加快程序的装入过程，而且可节省大量的内存空间。

*该方法是目前最常使用的链接方式。*

## 4.3 連續分配方式

- 连续分配方式，是指为一个用户程序分配一个连续的内存空间。
- 连续分配方式有四种:
  1. 单一连续分配
  2. 固定分区分配
  3. 动态分区分配
  4. 动态重定位分区分配

### 4.2.1 單一連續分配

它规定整个内存的用户区中只驻留一 个用户的一个程序，因此该方式只适用于单用户、单任务的操作系统。

为了防止OS的代码和数据被用户进程所破坏，把内存分为系统区和用户区 两部分:

1. 系统区:仅提供给0S使用，通常是放在内存的低址部分;
2. 用户区:是指除系统区以外的全部内存空间，提供给唯一的用户使用，存放用户程序和数据。

优缺点:简单、内存利用率低。

### 4.2.2 分區管理 - 固定分區分配

固定分区分配思想:将内存用户空间划分为若干个固定大小的区域，每个区域 称为一个分区(region)，在每个分区中只装入一道作业 ，从而支持多道程序 并发设计。

#### **分区大小**

1. 分区大小相等。当程序太小时，会造成内存空间的浪费 。当程序太大时，一个分区又不足以装入该程序，致使该程序无法运行。

2. 分区大小不等。可把内存区划成含有多个较小的分区、适量的中等分区及 少量的大分区。

#### 分區分配：固定分區分配

 当有作业要装入内存时，内存分配程序检索分区描述表，从中找出尚未使 用的最接近大小的分区分配给该作业，然后修改分区的状态;如果找不到合适 的分区就拒绝为该作业分配内存。当程序运行完成时，系统回收内存资源，并修改分区描述表中分区的状态。

優缺點：

最早的可运行多道程序的存储管理方式 。 

存在“内零头”会造成存储空间的浪费。

* 内零头——在分区内没有利用的部分称为内零头。

#### 分區分配：動態分區方式

动态分区分配思想:分区数量和大小都不固定，根据进程的实际需要，动态地 为之分配内存空间。

(1)分区分配数据结构 记录系统中各空闲分区的情况，以便分配时能找到可以分配的空间。

1. 空闲分区表。在系统中设置一张空闲分区表，用于记录每个空闲分区的情 况(包含空闲分区号、分区大小、起始地址)。

2. 空闲分区链表。为了实现对空闲分区的分配和链接，设置前向指针和后向 指针，通过前、后向链接指针将所有的空闲分区链接成一个双向链。

![空閒分區鏈錶](https://img.cetacis.dev/uploads/big/434e0854f453f3189fa76563a284226b.png)