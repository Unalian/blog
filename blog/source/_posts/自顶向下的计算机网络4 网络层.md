---
date: 2020/4/2
tags:
- 上课笔记
- 网络层
categories:
- 计算机网络
- 自顶向下的计算机网络
- 网络层
---

# 自顶向下的计算机网络4 网络层

## 5.1 概述

网络层在网络的主机和路由器中出现。

本章主要讨论网络层如何实现主机到主机的通信服务。 将分组从发送主机移动到接收主机。

分两个相互关联的部分讲解:数据平面和控制平面。

### 5.1.1 数据平面与控制平面

**数据平面功能：**

转发：每台路由器的功能。当一个分组到达某个路由器的输入链路时，该路由器必须将其移动到合适的输出链路。

**控制平面功能：**

选路：全网范围决定路由的功能。确定分组从发送方流向接收方时所经过的路由或路径。 通过选路算法计算路径。
<!-- more -->
**转发和选路区别：**

转发:将分组从路由器的一个输入链路接口转移到一个合适的输出链路接口 的本地动作。

• 只涉及分组在路由器中从入链路到出链路的传送。 • 通常用硬件实现。

选路:指分组从源到目的地的端到端路径的网络范围动作。

• 涉及网络中的所有路由器，集体经选路协议交互，决定分组从源到目的地的路径。

• 通常由软件实现。

**类比：**转发: 通过单个立交桥的过程 选路: 从起点到目的终点计划行程的过程。

#### 5.1.2 路由器如何转发分组

**转发表：**每台路由器有一张。路由器根据到达分组的首部值在转发表中查询，找 到相应的输出链路接口，并 将分组转发出去。

![转发](https://img.cetacis.dev/uploads/big/1b9120823790432c9a7e4c0f15cbd631.png)

**转发表是如何配置的：**

* 转发表的内容由选路算法决定
* 集中式（多台路由器有一个数据中心，或者由单点计算分发）或分布式（每台路由器单独生成自己的转发表） *不管哪一种，都有多台路由之间的交互*

#### 1. 控制平面

传统方式：每个路由器都有单独的路由算法组件，路由器之间通过交互来实现控制平面

SDN方法：一个分离的(通常是远程的)控制器和路由器本地的控制代理 (local controlagents，CAs) 交互。软件定义网络，由远程的控制器计算分发转发表。可以由isp或者专门的公司管理。

#### 2. 一些术语

**分组交换机：**一台通用分组交换设备，根据**分组首部值**，从输入链路接 口到输出链路接口传送分组。

**链路层交换机：**根据*链路层字段值*作转发决定的分组交换机。 

**路由器：**根据*网络层字段值*作转发决定的分组交换机。

#### 3. 建立连接

**传输层连接**: 如TCP协议，在数据实际传输之前，需要发送方 和接收方经过三次握手建立所需的状态信息。两个进程之间 建立连接

**网络层连接**: 指网络层数据分组开始传输前，在所选择的从源 到目的地路径上的各路由器之间相互握手，建立连接状态。

如ATM、帧中继、MPLS的网络层。(已经很少使用)。如今的因特网网络层不执行连接建立。

### 5.1.3 网络服务模型

问题：

* 发送主机的运输层是否能依靠网络层将分组交付到目的地; 
* 多个分组是否能按发送顺序交付给接收主机的运输层; 
* 传输两个连续分组的时间间隔是否与接收到的时间间隔相同; 
* 网络层是否能提供网络拥塞的反馈信息;

由网络层提供的服务模型来确定

#### **网络层可能提供的服务**

1. **网络层可能提供的服务**

   - 确保交付:确保分组到达目的地。

   - 有序分组交付:按发送顺序到达。

   - 具有时延上界的确保交付:主机到主

     机的时延。

   - 确保最小带宽:当发送主机以低于特

     定比特率的速率发送比特，分组不会

     丢失，在一定时延到达。

   - 确保最大时延抖动:发送方发送两个

     连续分组的时间间隔与接收到的间隔 相同。

2. **因特网的网络层提供的服务**• 单一服务，即尽力而为服务(best-effort service) 。
   * 分组间的定时不能被保证;
   * 分组的接收顺序与发送顺序不一定相同;
   *  传送的分组不能保证最终交付，即网络可能未向目的地交付分 组。

## 5.2 虚电路与数据报网络

### 5.2.1 网络层与运输层

• 运输层:提供无连接服务和面向连接服务。 如因特网的UDP、TCP 。

• 网络层:提供无连接服务和面向连接服务。

面向连接服务:源和目的主机之间先握手。 

无连接服务:无握手过程。

#### **网络层与运输层区别**

1. 服务对象

网络层:向运输层提供的主机到主机的服务。

运输层:向应用层提供的进程到进程的服务。

2. 服务选择

网络层:任何网络中的网络层只提供两种服务之一， 不会同时提供。

​	虚电路网络:仅在网络层提供连接服务的计算机网络。

​	数据报网络:仅在网络层提供无连接服务的计算机网络。（二选一

3. 实现

运输层:面向连接服务在网络边缘的端系统中实现。 

网络层:面向连接服务在端系统及网络核心的路由器中实现。

### 5.2.2 虚电路与数据报网络

#### 1. 虚电路

在数据传输前，需要为每一呼叫建立链接

每个分组携带vc标识符（不是目的主机地址

位于”源-目的地址“上每个路由器会维护经过它的每条链接的”状态“

#### 2. 数据报网络

* 在网络层无呼叫过程
* 路由器：不需要维护端到端链接的状态
* 没有网络等级的”链接“概念
* 使用目的主机的地址进行分组转发

*相同源和目的的分组可能采用不同的路径*

**数据报转发表**

如果为每个目的地址建立一个表项，那么将需要建立大约40亿个表项，因此转发表中采用地址范围来建立表项。某一前缀匹配专门的链路接口

最长前缀的匹配规则。

* 路由器转发表只维持转发信息;
* 转发表由选路算法修改(1~5分钟更新);虚电路网络转发表随虚电路的建立和拆除更新。
* 一个端系统发送给另一个端系统的一批分组可能在网络中选 择不同的路径，到达的顺序可能不一致。

**数据报网络的特点**

由互连计算机的需求发展而来。与电话网相反。

* 网络层服务模型简单。

* 端系统功能复杂:高层实现许多功能，如按序传送、可靠数据传输、拥塞 控制与DNS名字解析等;

带来的结果

* 因特网服务模型提供的服务保证最少(可能没有!)，对网络层的需求最小，使得**互连使用各种不同链路层技术的网络变得更加容易。 **

* 许多应用都在位于网络边缘的主机(服务器)上实现。

源主机和中转路由器都不知道完整路径

## 5.3 路由器的工作原理

网络层转发功能: 将分组从路由器的输入链路传送到适当的输出链路。

### 5.3.1 路由器的体系结构:

![路由器整体结构](https://img.cetacis.dev/uploads/big/f7f701b9a9f06ba62b8c90a30d699d5d.png)

选路处理器：选路算法

输入端口：确定要转发的方向

### 5.3.2 输入端口

物理层-第一个线路端接模块：将一条物理链路端接到路由器的物理层; bit为单位接收数据

链路层-第二个数据链路处理模块:实现路由器的数据链路层功能;进行分析，解封装

网络层-第三个查找与转发模块:实现查找与转发功能，以便分组通过路由器交换结构 转发到适当的输出端口;分散式转发：根据数据报的目的地址，使用输入端口内存中缓存的转发 表查找输出端口

交换结构：实现转发

输入端口——查找转发模块

确定将一个到达的分组通过交换结构转发给哪个输出端口。 通过查找转发表实现，这里的转发表是存储在输入端口的内存中。

#### 1.**分散式转发:**

选路处理器计算转发表，给每个输入端口存放一份转发表拷贝。 

在每个输入端口本地做出交换决策，无须激活中央选路处理器。 

可避免在路由器中某个单点产生转发处理瓶颈。

#### 2.表

**查表速度**

查表:搜索转发表，查找最长匹配的表项，若无相应表项找出默认选路表 项。

查找速度:受许多因素影响，如路由器速度、链路速率、查找算法等。

目标:输入端口的处理速度要超过线路速度。即完成一次查找的时间应少于从输入端口接收一个分组所需的时间(对收到的分组的输入处理在下一个接收操作结束之前完成)。（减少排队）

如，对运行速率为2.5Gbit/s的OC48链路，若分组长256B，查找速度 大约为每秒一百万次。

**查表方法**

线性查找：桉顺序查 （不适合庞大转发表

二分查找：转发表村房子树形结构中

三态内容可寻址内存（TCAM）

**输入端口问题**

* 分组阻塞

来自其他输入端口的分组当前正在使用交换结构。被阻塞的分组必须在输入端口处排队，等待以后调度通过交换结构。除查找这个最基本的动作外，在输入端口还必须采取其他动作:

1. 必须实现物理层和链路层处理
2. 必须检查分组的版本号、检验和以及TTL字段。
3. 必须更新用于网络的管理的计数器。（ 管理统计端口的流量，动态调整端口流量。

### 5.3.3 交换结构

#### 1. 三种类型 概述

![](https://img.cetacis.dev/uploads/big/c42a9aa170ffb58d853e9d16f0e7cfa0.png)

#### 2. 经内存的交换结构

早期用计算机作为路由器时采用的结构(第一代)

* 输入端口与输出端口之间的交换由CPU(选路处理器)控制完成;

* 输入端口与输出端口类似I/O设备:

  *  当分组到达输入端口时，通过中断向选路处理 器发出信号，将分组拷贝到处理器内存中;

  *  选路处理器根据分组中的目的地址查表找出适 当的输出端口，将该分组拷贝到输出端口的缓存中。

**转发速度**

交换速度受总线带宽的速度限制 (每个分组穿过两次总线)

若总线带宽为每秒写入或读出B个分组，则总的转发吞吐量 (分组 从输入端口被传送到输出端口的总速率)小于B/2。

#### 3. **经总线的交换结构**

输入端口通过一条共享总线将分组直接传送到输出端口，不需要 选路处理器的干预。

* 每次只能有一个分组通过总线传送。
* 分组到达一个输入端口时，若总线正忙，会被暂时阻塞，在输入端口排队
* 路由器交换带宽受总线速率限制。

#### 4. 经交换矩阵交换(经互联网络交换)结构

纵横式交换机:由2n 条总线组成，n 个输入端口与n 个输出端口连接。

到达输入端口的分组沿水平总线穿行，直至与所希望的输出端口的垂直总线交叉点:

* 若该条垂直总线空闲，则分组被传送到输出端口;
* 否则，该到达的分组被阻塞，必须在输入端口排队。

![](https://img.cetacis.dev/uploads/big/8b2ccbb3fe8ec8f8a93cebaa11444673.png)

高级设计:更为复杂的互 联网络使用多级交换元 素 ， 以使来自不同输入 端口的分组通过交换结 构同时朝着相同的输出 端口前行 。

### 5.3.4 排队

取出存放在输出端口内存中的分组，并将其传输到输出链路上。

当交换结构将分组交付给输出端口的速率超过输出链路速率，就需要排队与缓存管理功能。当输出端口的缓冲区溢出时，就会出现延时和丢包。

#### 1. **输入端口不排队**

若交换结构的速率至少是输入线路速率的n倍，在输入端口处不会出现排队。

#### **2. 输入端口分组排队**

交换结构比输入端口总和的速度慢: 输入队列产生排队

交换结构不够快，即相对于输入线路速度不能快得使所有到达的分 组无延迟地通过它传送，则在输入端口出现分组排队，以等待通过交换 结构传送到输出端口。

线路前部HOL (head-of-the-line)阻塞: 输入队列中后面的分组被位于线路头的一个分组阻塞(即使输出端口空

闲的)，等待通过交换结构发送。

#### 3. 输出端口分组排队

设交换结构的速率至少是线路速率的n倍。

最坏情况:到达每个输入端口的分组都被发往同一个输出端口。

* 在一个单位时间(接收或发送一个分组)内，将有n个分组到达该输出端口， 排队(等待)发送到输出链路上;
* 在发出队列中一个分组的时间内，又有n个分组到达。

依此类推，最终排队的分组快速增长，很快占满输出端口的存储空间， 使后续分组被丢弃。

#### 4. 分组丢弃方法

若缓存已满，丢弃分组。 

* 丢弃后到的分组(弃尾); 
* 删除一个或多个已排队的分组;
  * 主动队列管理AQM算法:在缓存填满前丢弃分组或首部加标记，向发送 方提供拥塞信号。
  * 如，随机早期检测RED算法: 输出队列长度维护一个加权平均值。

### 5.3.5 分组调度程序

在输出端口排队的分组中选出一个发送。 原则:

先来先服务FCFS:简单。

优先权排队:具有优先级。

加权公平排队WFQ:在具有排队分组的不同端到端连接之间公平地共享输 出链路。

#### 1. 先来先服务FCFS

* 按到达的顺序发送分组;
* 如果分组到达时，没有足够的缓存空间，该如何丢弃分组?
  *  尾弃
  * 基于优先级删除 (比如已有跳数)
  * 随机删除

#### 2. 优先权排队

**优先级调度**:

* 输出队列分类为多个具有不同优先级队列;

* 根据到达分组的类型，引导到不同优先级的 队列中。

* 优先发送具有最高优先级队列中的分组;

但是在低优先级发送时，高优先级不能抢占低优先级。

#### 3. 循环加权公平队列

**循环队列规则**:

* 输出队列按类分为多个队列，不同类之间没有严格的服务优先权区分。 
* 据到达分组的类型，引导到不类别的队列中。
* 循环调度器在这些不同类所对应的队列中轮流提供服务。

**加权公平排队（WFQ）**

* WFQ也循环为各个不同类的队列提供服务;

* 但是不同类的队列，在每个循环周期中，所获得的服务量并不平等，而 是由其权值决定。

## 5.4 网络协议：因特网中的转发和编制

### 5.4.1 因特网中的网络协议 IPv4

#### 1. IPv4 (IP数据报格式)

![](https://img.cetacis.dev/uploads/big/4ab981c8f08db2c1bf606febc875d949.png)

**版本：**IPv4/IPv6

**区分服务**：比如实时流量/分时流量/vip服务 不同的数据报类型。

**总长度：**首部+数据（byte） 应小于mtu（连路层最大传送单元 MTU

**标识：**它是一个计数器，用来产生数据报的标识。

**生存时间TTL：**在一次转发时 -1，当生存时间到0，则销毁此报文，防止形成回环。

**协议：**多种协议，协议字段指出了应将数据部分交给哪一个上层协议

![](https://img.cetacis.dev/uploads/big/ed540030996b58656482000d645b60fd.png)

**首部检验和**:(16 位)字段只检验数据报的首部 不检验数据部分。这里不采用 CRC 检验码而采用简单的计算方法。

IPv4支持首部可变部分，IPv6不支持

#### 2. IPv4数据分片和重组

* 每个数据链路有自己的MTU，链路类型 不同，MTU的值也不同，这里MTU指的 是数据链路帧的数据区的最大字节数（在发送的过程中，可能在链路层有不同的协议，即不同的MTU，会使已有的网络层数据报无法传送，则需要分片（变得更小）或者重组（变得更大）
* 为了进一步识别出这些分组，需要对分 片进行标识

**问题：**

* 当一台目的主机从相同源收到一系列的数据报的时候，它需要确定，这些数据报中的某些是否是一些原来较大的数据报的片?

在添加源地址和目的地址时，还会为该报文段，添加标识字段， 分片后的每个片，都具有相同的源地址和目的地址，以及相同的标识。（***标识、标志、片偏移***）

标识：同一个源主机分片，每一个+1。

* 如果是某些数据报的片，则它必须进一步确定何时收到了最后一片?

标志字段中MF=0，则标识最后一个片

* 它如何将这些片拼接还原为原来的初始数据报?

通过片偏移字段，标识该片在初始IP数据报中的哪个位置。

**分片的例子**

4000 MTU = 1500

只分数据段 4000 - 20； 1500 - 20

偏移量 ： 第一个 = 0 第二个 1480/8(byte) 第三个 2*1480/8

长度：第一个 = 1500 第二个 = 1500 第三个 = 1040 （4000 - 20 -（1500-20）* 2 +20）

标志：前几个都是0 最后一个是1

标识符：= 都一样

**分片的问题**

* 分片是有开销的。

* 使路由器和端系统更为复杂。

* 分片能够被用于生产致命的DoS攻击。（模拟分片/序号错乱）

  *IPv6取消分片：当无法适应MTU，则返回源主机重发信息*

### 5.4.2 IP

#### 1. IP地址

IP 地址: 分配给主机或路由器**接口**的标识符（每一个路由器、主机都可有多个接口）IP地址与接口相关联

接口: 主机/路由器与物理链路之间的 边界

* 路由器有多个接口

* 主机可以有多个接口 
* 每个接口有一个IP地址

IP地址两种：

* IPV4:32个二进制位长(4字节)，常用点分十进制表示;

* IPV6:128个二进制位长(16字节) 常用冒号分隔表示

#### 2. IPv4编制

32比特二进制和点分十进制的方法

将4个字节中的每一个字节分别用十进制数来表示，4个十进制数之间如

223.1.1.1 = 11011111 00000001 00000001 00000001

#### 3. IP地址结构

IP 地址是一种分等级的地址结构，包括两部分: 

* 网络号:指明主机所在网络的编号。
* 主机号:主机在网络中的编号。主机号为全0和全1的两个地址不能使用，用于特殊的目的!

**IP地址分两个等级的好处是:**

第一，IP 地址管理机构在分配 IP 地址时**只分配网络号**，而剩下的主机号则由得到该网络号的单位自行分配。这样就方便了 IP 地址的管理。

第二，路由器**仅根据目的主机所连接的网络号来转发分组**(而不考虑目的主 机号)，这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所 占的存储空间。

#### 4. 早期IP地址分类

![早期IP地址分类](https://img.cetacis.dev/uploads/big/6432c55a9ad7a000b62da31ee2470846.png)

* **A类**

A类IP地址的**网络号长度为8位，主机号长度为24位**; 

A类地址是从:1.0.0.1~127.255.255.254; 

网络号可变长度为7位，从理论上可以有27=128个网络; 

网络号为全0和全1(用十进制表示为0与127)的两个地址保留用于特殊目 的，实际允许有126个不同的A类网络; 

由于主机号长度为24位，因此每个A类网络的主机IP数理论上为224=16 777 216; 

主机IP为全0和全1的两个地址保留用于特殊目的，每个网段实际允许连接 16 777 214个主机; 

A类IP地址结构适用于有大量主机的大型网络。 

* **B类**

B类IP地址的**网络号长度为**16位**，**主机号长度为16位

B类IP地址是从:128.0.0.1~191.255.255.254;

 适合国际性大公司与政府机构等中等大小的组织

* **C类**

C类IP地址的**网络号**长度为**24**位**，**主机号**长度为**8位;

C类IP地址是从:192.0.0.1~223.255.255.254;

适用于小公司 普通研究机构

* **D类**

  D类IP地址不标识网络;  224.0.0.0 - 239.255.255.255

  多地址

* **E类** 

240.0.0.0-255.255.255.255

实验使用 保留

#### 5. 特殊IP地址段

*  0.0.0.0

这个地址严格上来说都不是真正意义上的IP地址。主要是用来标识不清楚 的网络和主机的。系统遇到无法识别的网络或主机的时候会统一的归纳到 这个地址

* 255.255.255.255 这个地址是受限的广播地址。

主要指一个网段内的所有主机

* 127.0.0.1

这个是预留的一个IP地址，主要是用来识别电脑自己本身的地址。也叫做“localhost”一般用来测试使用的。做开发的人比较熟悉。

* 10.x.x.x, 172.16.x.x-72.31.x.x, 192.168.x.x.

这三个地址段主要是我们私有的内网地址。也就是我们平时企业或者家里局 域网所使用的地址段，我们比较熟悉的应该就是192.168.x.x 这个地址段了， 在公网不能路由。(RFC1918中保留)

#### 6. **互联网中的IP地址**

同一局域网上的主机或路由器的IP地址中的网络号必须相同。 用IP术语来说，具有相同网络号的局域网，称为子网。 ( 在 因特网文献中 ， 子网也称为 1P 网络或直接称为网络 。 )

交换机互连的网络仍然是一个局域网，只能有一个网络号。

路由器总是具有两个或两个以上IP地址。

当两个路由器直接相连时，在连线两端的接口处，可以指明 IP地址也可以不指明IP地址。

![](https://img.cetacis.dev/uploads/big/b3ac94848eeae3738de05f33fd21f42a.png)

#### 7. 子网

**划分子网**

IP 地址: 網絡號+ 主機號 网络号相同的IP地址属于同 一个网络。而网络还可以划 分为若干子网

划分子网的方法：从主机号 借用若干个比特作为子网号 ，剩下的主机位为主机号。

![](https://img.cetacis.dev/uploads/big/053b07a71dee3bdf8edbf9fdf6cb4742.png)

**子網特點**

什么是一个子网 ?

* 设备接口的IP地址具有同 样的网络部分
* 没有路由器的介入，物理 上能够相互到达

**子网掩码**

- 子网号字段长度是可变的，因此，为了确定子网地址，IP协议提

  供了子网掩码的概念 。

- 子网掩码用来确定网络地址(包括网络号和子网号)和主机地址 的长度。子网掩码长为32位比特，其中的1对应于IP地址中的网 络号和子网号，而子网掩码中的0对应于主机号。

![](https://img.cetacis.dev/uploads/big/19e15b01d1cd5a1d5c9f31d93d302f62.png)

![](https://img.cetacis.dev/uploads/big/aba86e09488e237699bf4ef9342b2473.png)

#### 8. 技术发展

一个A类的IP地址，可以有24bit用于分配主机地址，因此可以 支持 224个主机，但是一个家庭或者组织往往不需要这么多的地 址空间，造成浪费。 

 一个C类的IP地址，只有8bit用于分配主机地址，因此只能支持 256个主机，又不太够用。 

 因此，按传统IP地址分类方式分配IP被CIDR技术取代 

***CIDR*** ： 无类别无间路由 网络前缀+主机号

a.b.c.d/x  （x是地址网络部分的bit数 地址中的网络部分可以任意长(**IP**地址前缀或网络前缀)

CIDR将网络前缀都相同的连续的IP地址组成“CIDR地址块”。

CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因 而可以更加有效地分配 IPv4 的地址空间。

*子网掩码：*/x的计法和255.255.255.0 都属于子网掩码

**构造超网**

一个公司或组织通常被分配一块连续的地址块，即具有相同前缀的一段地址。 

 CIDR将网络前缀都相同的连续的IP地址组成“CIDR地址块”。
 一个CIDR地址块可以表示多个内部的子网的集合，这种地址的聚合称为路由聚合，又称为构成超网。

![](https://img.cetacis.dev/uploads/big/9273227069681117e02deaa2f0510c18.png)

![](https://img.cetacis.dev/uploads/big/05103f17bfe105dad5a7a6cdaab3c9b1.png)

**全0 全1 都是不能作为主机号**

![](https://img.cetacis.dev/uploads/big/e7c98a247bcbc19b1228645cc73a0942.png)

![](https://img.cetacis.dev/uploads/big/bcb4eff878dbb9ff35ca8f74c121defb.png)

单播地址：主机号不为全1或者全0

#### 9. IP地址获取

**主机如何得到IP地址**

**手工指定(保存在系统配置中) **

• Windows: 控制面板->网络   • UNIX/LINUX: 在/etc/rc.config中，可使用ifconfig命令配置 

**DHCP: Dynamic Host Configuration Protocol**

• 自动从一个DHCP服务器得到IP地址 • 方便灵活

**DHCP分配的不仅仅是IP地址，还可分配:**
• 客户的第一跳路由器的地址(网关) • DNS服务器的IP地址或域名• 子网掩码

DHCP是应用程协议

**动态主机配置协议**

plug-and-play(即插即用) 

DHCP概述:

• 主机广播 “DHCP DISCOVER” 消息
• DHCP 服务器用 “DHCP OFFER” 消息响应
• 主机请求IP地址: “DHCP REQUEST” 消息
• DHCP 服务器确认 “DHCP ACK/NACK” 消息 • DHCP 终止租用期”DHCP RELEASE”消息

DHCP具体过程

* DHCP打开udp端口67 等待客户端发来的报文，等待客户端发来的报文
* DHCP客户从udp端口68发送dhcp发现报文
* 凡收到dhcp发现报文的dhcp服务器都发出dhcp提供报文。客户端收到多个DHCP提供的报文。
* 客户端选择一个ip，广播告诉大家我选了某个，未被选中的ip提供者回收ip （DHCP REQUEST）
* 被选中的DHCP发送确认报文DHCPACK 客户端绑定，开始使用临时IP地址

租用期（lifetime）为T，DHCP有两个计时器T1 T2 。T1 = 0.5T T2 = 0.875T。超时则请求更新租用期

* T1到，客户端发送DHCP REQUEST 要求更新租用期
* 服务端不同意，发回否认报文 DHCPNACK，客户端必须立即停止使用原来的ip地址，重新申请ip地址（discover）
* 若同意，服务端发送确认报文 dhcpack 客户得到新的租用期，重新设置计时器
* 如果服务端不相应T1 到达T2，则重新发送request
* 客户端可随时终止服务器提供的租用期，只需要发送DHCP RELEASE

![](https://img.cetacis.dev/uploads/big/e06d4aedea07a6bbee0aa09fb5015eac.png)

Discover ：src: 本机 dest:目标（广播）yiaddr（被分配的ip地址）: 无ip所以为全0 t

​					ransaction ID: 传输id。相同则为对应恢复

offer: 租用时间 : 3600 secs

request: 广播原因：告诉别的dhcp服务器别等了，我已经选了某台了。服务端回收ip。

**DHCP** **中继代理(relay agent)**

- 并不是每个网络上都有 DHCP 服务器，这样会使 DHCP 服务器的数量太多。 现在是每一个网络至少有一个 DHCP 中继代理(通常是一台路由器)，它配置 了 DHCP 服务器的 IP 地址信息。

- DHCP 中继代理收到主机发送的发现报文后，就以单播方式向 DHCP 服 务器转发此报文，并等待其回答。收到 DHCP 服务器回答的提供报文后， DHCP 中继代理再将此提供报文发回给主机。

#### 10 关于ip地址及域名的获得 NAT協議

ISP获得地址块方法--ICANN

**ICANN**(Internet Corporation for Assigned Names and Numbers)

* 分配IP地址
* 管理DNS
* 分配域名，解决纠纷

*ICANN( Internet Corporation for Assigned Names and Numbers ，互联网名称与数字地址分配机构)是一个非营利性的 国际组织，成立于1998年10月，是一个集合了全球网络界商业、 技术及学术各领域专家的非营利性国际组织，负责互联网协议 (IP)地址的空间分配、协议标识符的指派、通用顶级域名 (gTLD)以及国家和地区顶级域名(ccTLD)系统的管理、以及 根服务器系统的管理。这些服务最初是在美国政府合同下由互联 网号码分配当局(Internet Assigned Numbers Authority，IANA) 以及其它一些组织提供。现在，ICANN行使IANA的职能。*

**NIC**

所有的IP地址都由ICANN规划，然后主要由国际组织NIC(Network Information Center)具体负责统一分配。

目前全世界共有五个这样的网络信息中心

我国申请IP地址要通过APNIC，APNIC的总部设在日本东京大学。申请时要考虑申 请哪一类的IP地址，然后向国内的代理机构提出。

IPV4地址段早就枯竭了

**NAT 网络地址转换**

![](https://img.cetacis.dev/uploads/big/a3dfd50269006d3d1337e17ca1995a23.png)

10.0.##  192.168.## 都是私网ip。他们有共同的源端up地址，有不同的源端口号

动机： 对于外部网络来讲，本地网络只用一个ip地址

* 不需要从isp分配一系列地址——只要一个ip地址用于所有设备
* 在本地网络 改变设备的ip地址不通知外界
* 更新isp不用更新本地的设备地址
* 本地网络内部设备不能被外部世界明确寻址，或不可见（安全）

![](https://img.cetacis.dev/uploads/big/fbf732015ffbbcf2e462d608b041fcab.png)

**执行NAT，路由器必须做到:**

* 外出的分组: 替换每个外出的分组的 (源IP 地址, 端口号) 为 (NAT IP 地址, 新端口号)

  远程客户/服务器用(NAT IP地址, 新端口号)作为目的地来响应。 

* 在NAT转换表中，记录了每个(源IP 地址, 端口号)到 (NAT IP地址, 新端口号) 的对应关系。

* 进来的分组: 对每个进来的分组，用保存在NAT表中的对应的(源 IP 地址, 端口号) 替换分组中的目的域 (NAT IP 地址, 新端口号)

**NAT: 网络地址转换的一些限制**

16-bit 端口号: 一个局域网地址可以同时支持60,000个并发连接!

NAT 存在争议: 端口号，仅用于进程变址  路由器只应该处理到第三层 端口号是运输层

​						违反了端到端主张：应用程序设计者在设计时不得不将NAT加以考虑，如P2P应用程序

​						应使用IPv6来解决地址短缺问题

UNnP (通用即插即用)

*NAT违背了计算机网络分层的思想，伪首部说明TCP、IP协议没有为严格分层* 

（沒有校驗合）

#### 11. **ICMP: (Internet Control Message Protocol**， 因特网控制报文协议）

用于主机路由器之间彼此交流网络层信息：

* 差错报告: 不可到达的主机, 网络,端口,协议
* 请求/应答 (用于ping,traceroute)

”位於ip之上“

* ICMP消息是裝載在ip分組裡 （ip協議字段標明有否icmp）
* 但是真正的數據，ICMP包文是在ip數據中的

![](https://img.cetacis.dev/uploads/big/068b64ac5b008cecf35497c348c96165.png)

ICMP 报文结构:

类型字段, 编码字段、校验和字 段以及不同报文类型所加载的 数据。如果是差错报告，则后 面的数据包含引起该ICMP报文 的IP分组的报头和分组中的前8 字节的数据。

![重要的icmp报文结构](https://img.cetacis.dev/uploads/big/948e5a2d33e20583af434c9b0b9f5930.png)

![](https://img.cetacis.dev/uploads/big/545b1e03766d41cb8d2f18e42edc6fc3.png)



#### 13. 虚拟专用网vpn（）

* 多个分散的机构需要形成一个专用网进行通信时，利用因特网来实现多个分散机构的专用网，这样的专用网就称为虚拟专用网VPN：将IP地址
* 配置成目标的内网ip

vpn的实现：隧道技术

将一个内网中的10.1.0.1的ip数据报封装在数据部分发出，到目的内网解封，好像就是内网之间的交流。

![](https://img.cetacis.dev/uploads/big/92164205c6b85ffc40b924793a5b1f78.png)

#### 14. IPv6

初始动机: 32-bit 地址空间即将用尽。

其他动机:1. 首部格式可帮助加速处理/转发 2. 改变首部利于QoS要求

首部格式改变: 1. IPv6 数据报:扩大的地址容量 2. 简化高效的 40 字节首部 3. 流标签

![](https://img.cetacis.dev/uploads/big/1533821297d0e9d21f88bff644df23ee.png)

增加地址空间 首部简化（减少可选项）流标签 还没有确定 

流量类型:表示流中分组的优先级,类似IPv4中的TOS字段，可用于给出给出一个流中某些数据的优先级。

流标签: 表示分组在同一个 “流”中 (“流”的概念尚未完全定义).

下一个首部: 表示数据的上层协议，类似IPv4中的协议字段。

跳限制：类似于ttl

校验和: 全部去掉，减少每一跳的处理时间

选项: 允许, 但是不是标准首部的一部分，而是用下一个首部域 指出

ICMPv6  :新版本的 ICMP （不会重新分片，而是回发错误信息，按照新的方式进行封装）
• 增加消息类型, 例如“分组太大”     • 多播组管理功能

![](https://img.cetacis.dev/uploads/big/27c91f4920f4dbb0b5afb99f0b9e35ee.png)

地址还有其他压缩方法

**ipv4到ipv6的过渡**

并不是所有的路由器都能够同时升级

• 没有 “标志日”

• 同时有 IPv4 和 IPv6 路由器的网络如何工作?

两种推荐方法:

• 双栈:一些路由器具有双重栈 (v6, v4) 能够在两种格式中转换

• 隧道: 在穿过IPv4路由器时，IPv6分组作为 IPv4分组的负载